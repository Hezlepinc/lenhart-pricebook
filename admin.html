<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lenhart Price Book - Admin</title>
    <style>
        :root {
            --gray: #6d7b8a;
            --blue: #3b6e9c;
            --gold: #c4a35a;
            --text: #333333;
            --bg: #f5f5f5;
            --white: #ffffff;
            --good: #22c55e;
            --better: #3b82f6;
            --best: #a855f7;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        header {
            background: var(--gray);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--blue);
            color: white;
        }

        .btn-primary:hover {
            background: #2d5a80;
        }

        .btn-success {
            background: var(--good);
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid white;
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255,255,255,0.1);
        }

        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .upload-section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 1rem;
            text-align: center;
            border: 2px dashed #ccc;
        }

        .upload-section.drag-over {
            border-color: var(--blue);
            background: #f0f7ff;
        }

        .upload-section input[type="file"] {
            display: none;
        }

        .upload-section label {
            display: inline-block;
            padding: 1rem 2rem;
            background: var(--blue);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .upload-section label:hover {
            background: #2d5a80;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--blue);
        }

        .stat-card .label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }

        .filters {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters input,
        .filters select {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .filters input[type="search"] {
            flex: 1;
            min-width: 200px;
        }

        .category-section {
            background: white;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .category-header {
            background: var(--gray);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .category-header:hover {
            background: #5a6873;
        }

        .category-section.uncategorized .category-header {
            background: linear-gradient(135deg, #78716c 0%, #57534e 100%);
            border-left: 4px solid #f59e0b;
        }

        .category-section.uncategorized .category-header:hover {
            background: linear-gradient(135deg, #57534e 0%, #44403c 100%);
        }

        .uncategorized-badge {
            background: #f59e0b;
            color: #1c1917;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .category-header h2 {
            font-size: 1rem;
            font-weight: 600;
        }

        .category-header .badge {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .category-packages {
            display: none;
        }

        .category-packages.open {
            display: block;
        }

        .category-hero-setting {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: #f9f9f9;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .category-hero-setting label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }

        .category-hero-setting input {
            padding: 0.375rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .category-hero-setting input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .category-hero-setting input[type="number"] {
            width: 100px;
        }

        .hero-setting-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .package-row {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
        }

        .package-row:hover {
            background: #f9f9f9;
        }

        .package-row-main {
            display: grid;
            grid-template-columns: 1fr 100px 150px 150px 120px;
            gap: 0.5rem;
            align-items: center;
        }

        .package-upsells {
            margin-top: 0.5rem;
            padding-left: 1rem;
        }

        .package-upsells:empty {
            display: none;
        }

        .package-upsells-label {
            font-size: 0.6875rem;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .upsell-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #e0f2fe;
            color: #0369a1;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 0.375rem;
            margin-bottom: 0.25rem;
        }

        .upsell-tag-remove {
            background: none;
            border: none;
            color: #0369a1;
            cursor: pointer;
            font-size: 0.875rem;
            line-height: 1;
            padding: 0;
            margin-left: 0.25rem;
        }

        .upsell-tag-remove:hover {
            color: #dc2626;
        }

        .package-image-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-left: 1rem;
        }

        .package-image-row:empty {
            display: none;
        }

        .package-image-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .package-image-input {
            flex: 1;
            padding: 0.25rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .package-image-input::placeholder {
            color: #999;
        }

        .image-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.6875rem;
            cursor: pointer;
            background: var(--blue);
            color: white;
        }

        .image-btn.remove {
            background: #ef4444;
        }

        .package-row .name {
            font-weight: 500;
            font-size: 0.875rem;
        }

        .package-row .name small {
            display: block;
            color: #666;
            font-weight: 400;
            font-size: 0.75rem;
        }

        .package-row .price {
            font-weight: 600;
            color: var(--gold);
        }

        .package-row .hours {
            color: #666;
            font-size: 0.875rem;
        }

        .tier-select {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.75rem;
        }

        .tier-select.good {
            background: #dcfce7;
            border-color: var(--good);
        }

        .tier-select.better {
            background: #dbeafe;
            border-color: var(--better);
        }

        .tier-select.best {
            background: #f3e8ff;
            border-color: var(--best);
        }

        .tier-select.premium {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .tier-select.value {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .upsell-select {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.75rem;
            max-width: 150px;
        }

        .category-select {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.75rem;
        }

        .tier-badge {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tier-badge.good {
            background: var(--good);
            color: white;
        }

        .tier-badge.better {
            background: var(--better);
            color: white;
        }

        .tier-badge.best {
            background: var(--best);
            color: white;
        }

        .tier-badge.premium {
            background: #f59e0b;
            color: white;
        }

        .tier-badge.value {
            background: #22c55e;
            color: white;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--text);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--good);
        }

        .bulk-actions {
            background: var(--blue);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .bulk-actions label {
            font-weight: 500;
        }

        .bulk-actions select,
        .bulk-actions button {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-size: 0.875rem;
        }

        .hidden {
            display: none !important;
        }

        /* Export modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }

        .modal h2 {
            margin-bottom: 1rem;
        }

        .modal p {
            margin-bottom: 1rem;
            color: #666;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        @media (max-width: 900px) {
            .package-row {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }

            .package-row > * {
                padding: 0.25rem 0;
            }
        }

        /* Image Position Adjuster */
        .position-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 1rem;
        }

        .position-modal.open {
            display: flex;
        }

        .position-modal-header {
            color: white;
            text-align: center;
            margin-bottom: 1rem;
        }

        .position-modal-header h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .position-modal-header p {
            opacity: 0.8;
            font-size: 0.875rem;
        }

        .position-frame {
            width: 100%;
            max-width: 600px;
            height: 250px;
            border: 3px solid var(--gold);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: grab;
            background: #333;
        }

        .position-frame:active {
            cursor: grabbing;
        }

        .position-frame img {
            position: absolute;
            min-width: 100%;
            min-height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .position-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .position-controls button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }

        .position-save {
            background: var(--good);
            color: white;
        }

        .position-cancel {
            background: #666;
            color: white;
        }

        .position-reset {
            background: var(--blue);
            color: white;
        }

        .adjust-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.6875rem;
            cursor: pointer;
            background: var(--gold);
            color: white;
            margin-left: 0.5rem;
        }

        .adjust-btn:hover {
            background: #b8943f;
        }
    </style>
</head>
<body>
    <header>
        <h1>Lenhart Price Book Admin</h1>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="loadFromStorage()">Load Saved</button>
            <button class="btn btn-outline" onclick="saveToStorage(false)">Save Progress</button>
            <button class="btn btn-success" onclick="exportJSON()">Export JSON</button>
        </div>
    </header>

    <main>
        <div class="upload-section" id="uploadSection">
            <p style="margin-bottom: 1rem; color: #666;">Upload a new CRM export (CSV or XLS) to update packages</p>
            <input type="file" id="fileInput" accept=".csv,.xls,.xlsx">
            <label for="fileInput">Choose CSV File</label>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: #999;">Or drag and drop a file here</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="value" id="totalPackages">0</div>
                <div class="label">Total Packages</div>
            </div>
            <div class="stat-card">
                <div class="value" id="totalCategories">0</div>
                <div class="label">Categories</div>
            </div>
            <div class="stat-card">
                <div class="value" id="assignedTiers">0</div>
                <div class="label">Tiers Assigned</div>
            </div>
            <div class="stat-card">
                <div class="value" id="upsellsConfigured">0</div>
                <div class="label">Upsells Set</div>
            </div>
            <div class="stat-card">
                <div class="value" id="imagesSet">0</div>
                <div class="label">Images Set</div>
            </div>
        </div>

        <div class="bulk-actions">
            <label>Bulk Actions:</label>
            <select id="bulkCategory">
                <option value="">Change Category...</option>
            </select>
            <select id="bulkTier">
                <option value="">Set Group...</option>
                <option value="good">Good</option>
                <option value="better">Better</option>
                <option value="best">Best</option>
                <option value="premium">Premium</option>
                <option value="value">Value</option>
                <option value="">Clear Group</option>
            </select>
            <button class="btn btn-primary" onclick="applyBulkActions()">Apply to Visible</button>
        </div>

        <div class="filters">
            <input type="search" id="searchInput" placeholder="Search packages...">
            <select id="categoryFilter">
                <option value="">All Categories</option>
            </select>
            <select id="tierFilter">
                <option value="">All Groups</option>
                <option value="none">No Group Assigned</option>
                <option value="good">Good</option>
                <option value="better">Better</option>
                <option value="best">Best</option>
                <option value="premium">Premium</option>
                <option value="value">Value</option>
            </select>
        </div>

        <div id="categoriesContainer"></div>
    </main>

    <div class="toast" id="toast"></div>

    <!-- Position Adjuster Modal -->
    <div class="position-modal" id="positionModal">
        <div class="position-modal-header">
            <h3>Adjust Hero Image Position</h3>
            <p id="positionCategoryName">Drag the image to position it</p>
        </div>
        <div class="position-frame" id="positionFrame">
            <img id="positionImage" src="" alt="Hero image">
        </div>
        <div class="position-controls">
            <button class="position-reset" onclick="resetImagePosition()">Reset</button>
            <button class="position-cancel" onclick="closePositionAdjuster()">Cancel</button>
            <button class="position-save" onclick="saveImagePosition()">Save Position</button>
        </div>
    </div>

    <script>
        // State
        let pricebookData = null;
        let allCategories = [];
        let openCategories = new Set(); // Track which categories are expanded

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Try to load existing pricebook.json
            try {
                const response = await fetch('data/pricebook.json');
                if (response.ok) {
                    pricebookData = await response.json();

                    // Migrate "Other Services" to "Uncategorized" first
                    migrateOtherServicesToUncategorized();

                    // Also check localStorage for any saved changes
                    const saved = localStorage.getItem('pricebook-admin');
                    if (saved) {
                        const savedData = JSON.parse(saved);
                        // Migrate old localStorage data too
                        if (savedData.categories) {
                            const otherIdx = savedData.categories.findIndex(c => c.name === 'Other Services');
                            if (otherIdx !== -1) {
                                // Rename to Uncategorized in saved data
                                savedData.categories[otherIdx].name = 'Uncategorized';
                                savedData.categories[otherIdx].packages.forEach(p => p.category = 'Uncategorized');
                            }
                        }
                        // Merge saved tier/upsell data
                        mergeSavedData(savedData);
                    }
                    renderData();
                }
            } catch (e) {
                console.log('No existing pricebook.json found');
            }

            setupFileUpload();
            setupFilters();
        });

        function mergeSavedData(saved) {
            if (!pricebookData || !saved) return;

            const savedPackages = new Map();
            saved.categories?.forEach(cat => {
                cat.packages?.forEach(pkg => {
                    savedPackages.set(pkg.id, pkg);
                });
            });

            // Also copy over category-level settings
            const savedCategories = new Map();
            saved.categories?.forEach(cat => {
                savedCategories.set(cat.name, cat);
            });

            pricebookData.categories.forEach(cat => {
                // Merge category-level settings
                const savedCat = savedCategories.get(cat.name);
                if (savedCat) {
                    if (savedCat.heroImage) cat.heroImage = savedCat.heroImage;
                    if (savedCat.heroImagePosition) cat.heroImagePosition = savedCat.heroImagePosition;
                    if (savedCat.startingAtOverride) cat.startingAtOverride = savedCat.startingAtOverride;
                }

                cat.packages.forEach(pkg => {
                    const savedPkg = savedPackages.get(pkg.id);
                    if (savedPkg) {
                        pkg.tier = savedPkg.tier;
                        pkg.upsellTo = savedPkg.upsellTo || [];
                        if (savedPkg.category && savedPkg.category !== pkg.category) {
                            pkg.category = savedPkg.category;
                        }
                    }
                });
            });

            // Migrate "Other Services" to "Uncategorized"
            migrateOtherServicesToUncategorized();
        }

        // Migrate any "Other Services" packages to "Uncategorized"
        function migrateOtherServicesToUncategorized() {
            if (!pricebookData) return;

            const otherServicesIdx = pricebookData.categories.findIndex(c => c.name === 'Other Services');
            if (otherServicesIdx === -1) return;

            const otherServices = pricebookData.categories[otherServicesIdx];

            // Find or create Uncategorized
            let uncategorized = pricebookData.categories.find(c => c.name === 'Uncategorized');
            if (!uncategorized) {
                uncategorized = { name: 'Uncategorized', packages: [], startingAt: Infinity };
                pricebookData.categories.push(uncategorized);
            }

            // Move all packages from Other Services to Uncategorized
            otherServices.packages.forEach(pkg => {
                pkg.category = 'Uncategorized';
                uncategorized.packages.push(pkg);
                if (pkg.price < uncategorized.startingAt) {
                    uncategorized.startingAt = pkg.price;
                }
            });

            // Remove Other Services category
            pricebookData.categories.splice(otherServicesIdx, 1);

            // Sort categories
            pricebookData.categories.sort((a, b) => a.name.localeCompare(b.name));
        }

        function setupFileUpload() {
            const uploadSection = document.getElementById('uploadSection');
            const fileInput = document.getElementById('fileInput');

            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('drag-over');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('drag-over');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) processFile(file);
            });
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                if (file.name.endsWith('.csv')) {
                    parseCSV(content);
                } else {
                    showToast('Please use CSV format', false);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(content) {
            const lines = content.split('\n');
            const headers = parseCSVLine(lines[0]);

            // Find column indices
            const colMap = {};
            headers.forEach((h, i) => {
                const lower = h.toLowerCase().trim();
                if (lower.includes('internal id')) colMap.id = i;
                else if (lower === 'name') colMap.name = i;
                else if (lower.includes('sales price')) colMap.price = i;
                else if (lower.includes('labor hours')) colMap.hours = i;
                else if (lower.includes('description')) colMap.description = i;
                else if (lower.includes('show on mobile')) colMap.showMobile = i;
            });

            const packages = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const row = parseCSVLine(lines[i]);
                const name = row[colMap.name] || '';
                if (!name) continue;

                const showMobile = row[colMap.showMobile] || 'Yes';
                if (showMobile.toLowerCase().includes('no')) continue;

                const price = parseFloat((row[colMap.price] || '0').replace(/[$,]/g, '')) || 0;
                if (price <= 0) continue;

                const displayName = name.replace(/^(AMSFL_|GENFL_)/, '').replace('INSTALL ', '').trim();

                packages.push({
                    id: row[colMap.id] || String(i),
                    name: name,
                    displayName: displayName,
                    price: price,
                    laborHours: parseFloat(row[colMap.hours] || '0') || 0,
                    description: row[colMap.description] || '',
                    category: categorizePackage(name),
                    tier: null,
                    upsellTo: []
                });
            }

            // Organize by category
            const categoryMap = new Map();
            packages.forEach(pkg => {
                if (!categoryMap.has(pkg.category)) {
                    categoryMap.set(pkg.category, { name: pkg.category, packages: [], startingAt: Infinity });
                }
                const cat = categoryMap.get(pkg.category);
                cat.packages.push(pkg);
                if (pkg.price < cat.startingAt) cat.startingAt = pkg.price;
            });

            pricebookData = {
                version: '1.0',
                lastUpdated: new Date().toISOString(),
                categories: Array.from(categoryMap.values()).sort((a, b) => a.name.localeCompare(b.name))
            };

            // Merge with any saved data
            const saved = localStorage.getItem('pricebook-admin');
            if (saved) {
                mergeSavedData(JSON.parse(saved));
            }

            renderData();
            showToast(`Loaded ${packages.length} packages!`, true);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function categorizePackage(name) {
            const patterns = [
                [/(PANEL|SERVICE.*PANEL|SUB PANEL)/i, 'Panel Upgrades'],
                [/SURGE/i, 'Surge Protection'],
                [/(E CAR|EV CIRCUIT|EV CHARGER)/i, 'EV Charging'],
                [/HOT TUB/i, 'Hot Tub Circuits'],
                [/240V.*CKT(?!.*EV)/i, 'Heavy Duty Circuits'],
                [/(OUTLET.*WP|WP.*OUTLET)/i, 'Exterior Outlets'],
                [/(FLOOD|SOFFIT|COACH LT|LANDSCAPE)/i, 'Exterior Lighting'],
                [/(RCAN|WAFER|RECESSED)/i, 'Recessed Lighting'],
                [/TAPE LT/i, 'LED Tape Lighting'],
                [/(OUTLET|SWITCH|DIMMER|RECEPTACLE)(?!.*WP)/i, 'Outlets & Switches'],
                [/(FIXTURE|LIGHT BOX|CHANDELIER|PENDANT)/i, 'Interior Lighting'],
                [/(FAN|CEILING FAN)/i, 'Ceiling Fans'],
                [/(EXHAUST|BATH FAN|VENT FAN)/i, 'Bathrooms'],
                [/(GEN |GENERATOR|18KW|22KW|24KW|26KW)/i, 'Home Generators'],
                [/INTERLOCK/i, 'Portable Generator'],
                [/(AIR CONDITIONER|A\/C|AC CIRCUIT)/i, 'HVAC Circuits'],
                [/(SMOKE|CARBON|CO DETECTOR)/i, 'Safety Devices'],
                [/(GFCI|GFI)/i, 'GFCI Protection'],
                [/BREAKER/i, 'Breakers'],
            ];

            for (const [regex, category] of patterns) {
                if (regex.test(name)) return category;
            }
            return 'Uncategorized';
        }

        function setupFilters() {
            document.getElementById('searchInput').addEventListener('input', filterPackages);
            document.getElementById('categoryFilter').addEventListener('change', filterPackages);
            document.getElementById('tierFilter').addEventListener('change', filterPackages);
        }

        function renderData() {
            if (!pricebookData) return;

            // Update stats
            let totalPackages = 0;
            let assignedTiers = 0;
            let upsellsConfigured = 0;
            let imagesSet = 0;

            pricebookData.categories.forEach(cat => {
                if (cat.heroImage) imagesSet++;
                cat.packages.forEach(pkg => {
                    totalPackages++;
                    if (pkg.tier) assignedTiers++;
                    if (pkg.upsellTo && pkg.upsellTo.length > 0) upsellsConfigured++;
                    if (pkg.image) imagesSet++;
                });
            });

            document.getElementById('totalPackages').textContent = totalPackages;
            document.getElementById('totalCategories').textContent = pricebookData.categories.length;
            document.getElementById('assignedTiers').textContent = assignedTiers;
            document.getElementById('upsellsConfigured').textContent = upsellsConfigured;
            document.getElementById('imagesSet').textContent = imagesSet;

            // Update category filter
            const categoryFilter = document.getElementById('categoryFilter');
            const bulkCategory = document.getElementById('bulkCategory');
            allCategories = pricebookData.categories.map(c => c.name);

            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            bulkCategory.innerHTML = '<option value="">Change Category...</option>';

            allCategories.forEach(cat => {
                // Skip Uncategorized here - we'll add it specially at the end
                if (cat === 'Uncategorized') return;
                categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
                bulkCategory.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            // Add Uncategorized option with special icon
            categoryFilter.innerHTML += `<option value="Uncategorized">âŠ˜ Uncategorized</option>`;
            bulkCategory.innerHTML += `<option value="Uncategorized">âŠ˜ Uncategorized</option>`;

            // Render categories
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            pricebookData.categories.forEach((cat, catIndex) => {
                const section = document.createElement('div');
                const isUncategorized = cat.name === 'Uncategorized';
                section.className = 'category-section' + (isUncategorized ? ' uncategorized' : '');
                section.dataset.category = cat.name;

                const tierCounts = { good: 0, better: 0, best: 0, premium: 0, value: 0 };
                cat.packages.forEach(pkg => {
                    if (pkg.tier && tierCounts.hasOwnProperty(pkg.tier)) tierCounts[pkg.tier]++;
                });

                const displayPrice = cat.startingAtOverride || cat.startingAt;
                const isOpen = openCategories.has(cat.name);
                const uncatBadge = isUncategorized ? '<span class="uncategorized-badge">HIDDEN FROM PRICEBOOK</span>' : '';
                section.innerHTML = `
                    <div class="category-header" onclick="toggleCategory(${catIndex})">
                        <h2>${cat.name} <span class="badge">${cat.packages.length} packages</span>${uncatBadge}</h2>
                        <div>
                            ${tierCounts.good ? `<span class="tier-badge good">${tierCounts.good} Good</span>` : ''}
                            ${tierCounts.better ? `<span class="tier-badge better">${tierCounts.better} Better</span>` : ''}
                            ${tierCounts.best ? `<span class="tier-badge best">${tierCounts.best} Best</span>` : ''}
                            ${tierCounts.premium ? `<span class="tier-badge premium">${tierCounts.premium} Premium</span>` : ''}
                            ${tierCounts.value ? `<span class="tier-badge value">${tierCounts.value} Value</span>` : ''}
                            ${cat.heroImage ? `<span class="tier-badge" style="background:#666;">ðŸ“·</span>` : ''}
                        </div>
                    </div>
                    <div class="category-packages ${isOpen ? 'open' : ''}" id="cat-${catIndex}">
                        <div class="category-hero-setting" onclick="event.stopPropagation()">
                            <div class="hero-setting-group">
                                <label>Hero Image:</label>
                                <input type="text" placeholder="Paste hero image URL"
                                       value="${cat.heroImage || ''}"
                                       onchange="setCategoryHeroImage('${cat.name}', this.value)">
                                ${cat.heroImage ? `<img src="${cat.heroImage}" style="height:40px;border-radius:4px;" onerror="this.style.display='none'">` : ''}
                                ${cat.heroImage ? `<button class="adjust-btn" onclick="openPositionAdjuster('${cat.name}')">Adjust</button>` : ''}
                            </div>
                            <div class="hero-setting-group">
                                <label>Starting At: $</label>
                                <input type="number" placeholder="${Math.round(cat.startingAt)}"
                                       value="${cat.startingAtOverride || ''}"
                                       onchange="setStartingAtOverride('${cat.name}', this.value)"
                                       title="Leave blank to use auto-calculated: $${Math.round(cat.startingAt)}">
                                ${cat.startingAtOverride ? `<span style="font-size:0.6875rem;color:#666;">(auto: $${Math.round(cat.startingAt)})</span>` : ''}
                            </div>
                        </div>
                        ${cat.packages.map((pkg, pkgIndex) => renderPackageRow(pkg, catIndex, pkgIndex)).join('')}
                    </div>
                `;

                container.appendChild(section);
            });
        }

        function renderPackageRow(pkg, catIndex, pkgIndex) {
            const tierClass = pkg.tier ? pkg.tier : '';
            const allPackageOptions = getAllPackageOptions(pkg.id);
            const upsells = pkg.upsellTo || [];

            // Build upsell tags
            let upsellTags = '';
            if (upsells.length > 0) {
                const upsellNames = upsells.map(id => {
                    const found = findPackage(id);
                    return found ? `<span class="upsell-tag">${found.displayName} <button class="upsell-tag-remove" onclick="removeUpsell('${pkg.id}', '${id}')">&times;</button></span>` : '';
                }).filter(Boolean).join('');

                if (upsellNames) {
                    upsellTags = `
                        <div class="package-upsells">
                            <div class="package-upsells-label">Upsells to:</div>
                            ${upsellNames}
                        </div>
                    `;
                }
            }

            // Build image row
            const imageRow = `
                <div class="package-image-row">
                    ${pkg.image ? `<img src="${pkg.image}" class="package-image-preview" onerror="this.style.display='none'">` : ''}
                    <input type="text" class="package-image-input" placeholder="Image URL (paste link or path)"
                           value="${pkg.image || ''}"
                           onchange="setPackageImage('${pkg.id}', this.value)"
                           onblur="setPackageImage('${pkg.id}', this.value)">
                    ${pkg.image ? `<button class="image-btn remove" onclick="setPackageImage('${pkg.id}', '')">Remove</button>` : ''}
                </div>
            `;

            return `
                <div class="package-row" data-id="${pkg.id}" data-tier="${pkg.tier || ''}">
                    <div class="package-row-main">
                        <div class="name">
                            ${pkg.displayName}
                            <small>${pkg.name}</small>
                        </div>
                        <div class="price">$${pkg.price.toLocaleString()}</div>
                        <select class="tier-select ${tierClass}" onchange="setTier('${pkg.id}', this.value)">
                            <option value="">No Group</option>
                            <option value="good" ${pkg.tier === 'good' ? 'selected' : ''}>Good</option>
                            <option value="better" ${pkg.tier === 'better' ? 'selected' : ''}>Better</option>
                            <option value="best" ${pkg.tier === 'best' ? 'selected' : ''}>Best</option>
                            <option value="premium" ${pkg.tier === 'premium' ? 'selected' : ''}>Premium</option>
                            <option value="value" ${pkg.tier === 'value' ? 'selected' : ''}>Value</option>
                        </select>
                        <select class="upsell-select" onchange="setUpsell('${pkg.id}', this.value); this.value='';" title="Upsell to...">
                            <option value="">Add upsell...</option>
                            ${allPackageOptions}
                        </select>
                        <select class="category-select" onchange="setCategory('${pkg.id}', this.value)">
                            ${allCategories.map(cat => `<option value="${cat}" ${cat === pkg.category ? 'selected' : ''}>${cat}</option>`).join('')}
                            <option value="Uncategorized" ${pkg.category === 'Uncategorized' ? 'selected' : ''}>âŠ˜ Uncategorized</option>
                        </select>
                    </div>
                    ${upsellTags}
                    ${imageRow}
                </div>
            `;
        }

        function getAllPackageOptions(excludeId) {
            let options = '';
            pricebookData.categories.forEach(cat => {
                options += `<optgroup label="${cat.name}">`;
                cat.packages.forEach(pkg => {
                    if (pkg.id !== excludeId) {
                        options += `<option value="${pkg.id}">${pkg.displayName} - $${pkg.price}</option>`;
                    }
                });
                options += '</optgroup>';
            });
            return options;
        }

        function toggleCategory(index) {
            const el = document.getElementById(`cat-${index}`);
            const isOpen = el.classList.toggle('open');
            // Track open state by category name
            const catName = pricebookData.categories[index]?.name;
            if (catName) {
                if (isOpen) {
                    openCategories.add(catName);
                } else {
                    openCategories.delete(catName);
                }
            }
        }

        function setTier(packageId, tier) {
            const pkg = findPackage(packageId);
            if (pkg) {
                pkg.tier = tier || null;
                // Update just the select element's class
                const row = document.querySelector(`.package-row[data-id="${packageId}"]`);
                if (row) {
                    row.dataset.tier = tier || '';
                    const select = row.querySelector('.tier-select');
                    if (select) {
                        select.className = 'tier-select ' + (tier || '');
                    }
                }
                saveToStorage();
                updateStats();
            }
        }

        function setUpsell(packageId, upsellId) {
            if (!upsellId) return;

            const pkg = findPackage(packageId);
            if (pkg) {
                if (!pkg.upsellTo) pkg.upsellTo = [];
                if (!pkg.upsellTo.includes(upsellId)) {
                    pkg.upsellTo.push(upsellId);
                    // Add upsell tag to the row
                    const row = document.querySelector(`.package-row[data-id="${packageId}"]`);
                    if (row) {
                        let upsellsDiv = row.querySelector('.package-upsells');
                        if (!upsellsDiv) {
                            upsellsDiv = document.createElement('div');
                            upsellsDiv.className = 'package-upsells';
                            upsellsDiv.innerHTML = '<div class="package-upsells-label">Upsells to:</div>';
                            row.querySelector('.package-row-main').insertAdjacentElement('afterend', upsellsDiv);
                        }
                        const found = findPackage(upsellId);
                        if (found) {
                            const tag = document.createElement('span');
                            tag.className = 'upsell-tag';
                            tag.innerHTML = `${found.displayName} <button class="upsell-tag-remove" onclick="removeUpsell('${packageId}', '${upsellId}')">&times;</button>`;
                            upsellsDiv.appendChild(tag);
                        }
                    }
                    saveToStorage();
                    updateStats();
                    showToast('Upsell added!', true);
                }
            }
        }

        function removeUpsell(packageId, upsellId) {
            const pkg = findPackage(packageId);
            if (pkg && pkg.upsellTo) {
                pkg.upsellTo = pkg.upsellTo.filter(id => id !== upsellId);
                // Remove the tag from DOM
                const row = document.querySelector(`.package-row[data-id="${packageId}"]`);
                if (row) {
                    const tags = row.querySelectorAll('.upsell-tag');
                    tags.forEach(tag => {
                        if (tag.querySelector(`button[onclick*="${upsellId}"]`)) {
                            tag.remove();
                        }
                    });
                    // Remove upsells div if empty
                    const upsellsDiv = row.querySelector('.package-upsells');
                    if (upsellsDiv && upsellsDiv.querySelectorAll('.upsell-tag').length === 0) {
                        upsellsDiv.remove();
                    }
                }
                saveToStorage();
                updateStats();
                showToast('Upsell removed', true);
            }
        }

        function setPackageImage(packageId, imageUrl) {
            const pkg = findPackage(packageId);
            if (pkg) {
                pkg.image = imageUrl.trim() || null;
                // Update just the image preview and remove button
                const row = document.querySelector(`.package-row[data-id="${packageId}"]`);
                if (row) {
                    const imageRow = row.querySelector('.package-image-row');
                    if (imageRow) {
                        let preview = imageRow.querySelector('.package-image-preview');
                        let removeBtn = imageRow.querySelector('.image-btn.remove');

                        if (imageUrl.trim()) {
                            if (!preview) {
                                preview = document.createElement('img');
                                preview.className = 'package-image-preview';
                                imageRow.insertBefore(preview, imageRow.firstChild);
                            }
                            preview.src = imageUrl.trim();
                            preview.style.display = '';

                            if (!removeBtn) {
                                removeBtn = document.createElement('button');
                                removeBtn.className = 'image-btn remove';
                                removeBtn.textContent = 'Remove';
                                removeBtn.onclick = () => setPackageImage(packageId, '');
                                imageRow.appendChild(removeBtn);
                            }
                        } else {
                            if (preview) preview.remove();
                            if (removeBtn) removeBtn.remove();
                        }
                    }
                }
                saveToStorage();
                updateStats();
            }
        }

        function setCategoryHeroImage(categoryName, imageUrl) {
            const cat = pricebookData.categories.find(c => c.name === categoryName);
            if (cat) {
                cat.heroImage = imageUrl.trim() || null;
                // Update just the preview image and adjust button
                const section = document.querySelector(`.category-section[data-category="${categoryName}"]`);
                if (section) {
                    const heroSetting = section.querySelector('.category-hero-setting .hero-setting-group');
                    if (heroSetting) {
                        let preview = heroSetting.querySelector('img');
                        let adjustBtn = heroSetting.querySelector('.adjust-btn');

                        if (imageUrl.trim()) {
                            if (!preview) {
                                preview = document.createElement('img');
                                preview.style.height = '40px';
                                preview.style.borderRadius = '4px';
                                preview.onerror = () => preview.style.display = 'none';
                                heroSetting.appendChild(preview);
                            }
                            preview.src = imageUrl.trim();
                            preview.style.display = '';

                            if (!adjustBtn) {
                                adjustBtn = document.createElement('button');
                                adjustBtn.className = 'adjust-btn';
                                adjustBtn.textContent = 'Adjust';
                                adjustBtn.onclick = () => openPositionAdjuster(categoryName);
                                heroSetting.appendChild(adjustBtn);
                            }
                        } else {
                            if (preview) preview.remove();
                            if (adjustBtn) adjustBtn.remove();
                        }
                    }
                }
                saveToStorage();
                updateStats();
            }
        }

        function setCategory(packageId, newCategory) {
            // Find and remove from old category
            let pkg = null;
            let oldCatIndex = -1;
            let pkgIndex = -1;

            pricebookData.categories.forEach((cat, ci) => {
                cat.packages.forEach((p, pi) => {
                    if (p.id === packageId) {
                        pkg = p;
                        oldCatIndex = ci;
                        pkgIndex = pi;
                    }
                });
            });

            if (!pkg || pkg.category === newCategory) return;

            // Remove from old category
            pricebookData.categories[oldCatIndex].packages.splice(pkgIndex, 1);

            // Add to new category
            pkg.category = newCategory;
            let newCat = pricebookData.categories.find(c => c.name === newCategory);
            if (!newCat) {
                newCat = { name: newCategory, packages: [], startingAt: pkg.price };
                pricebookData.categories.push(newCat);
                pricebookData.categories.sort((a, b) => a.name.localeCompare(b.name));
            }
            newCat.packages.push(pkg);
            newCat.packages.sort((a, b) => a.price - b.price);
            newCat.startingAt = Math.min(newCat.startingAt, pkg.price);

            // Remove empty categories
            pricebookData.categories = pricebookData.categories.filter(c => c.packages.length > 0);

            renderData();
            saveToStorage();
        }

        function findPackage(id) {
            for (const cat of pricebookData.categories) {
                for (const pkg of cat.packages) {
                    if (pkg.id === id) return pkg;
                }
            }
            return null;
        }

        function filterPackages() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const tierFilter = document.getElementById('tierFilter').value;

            document.querySelectorAll('.category-section').forEach(section => {
                const catName = section.dataset.category;
                if (categoryFilter && catName !== categoryFilter) {
                    section.classList.add('hidden');
                    return;
                }

                let hasVisible = false;
                section.querySelectorAll('.package-row').forEach(row => {
                    const name = row.querySelector('.name').textContent.toLowerCase();
                    const tier = row.dataset.tier;

                    let visible = true;
                    if (search && !name.includes(search)) visible = false;
                    if (tierFilter === 'none' && tier) visible = false;
                    if (tierFilter && tierFilter !== 'none' && tier !== tierFilter) visible = false;

                    row.classList.toggle('hidden', !visible);
                    if (visible) hasVisible = true;
                });

                section.classList.toggle('hidden', !hasVisible);

                // Auto-expand filtered categories
                if (hasVisible && (search || tierFilter)) {
                    const packagesDiv = section.querySelector('.category-packages');
                    packagesDiv.classList.add('open');
                }
            });
        }

        function applyBulkActions() {
            const bulkCategory = document.getElementById('bulkCategory').value;
            const bulkTier = document.getElementById('bulkTier').value;

            if (!bulkCategory && bulkTier === '') {
                showToast('Select an action first', false);
                return;
            }

            let count = 0;
            document.querySelectorAll('.package-row:not(.hidden)').forEach(row => {
                const id = row.dataset.id;
                const pkg = findPackage(id);
                if (pkg) {
                    if (bulkTier !== '') {
                        pkg.tier = bulkTier || null;
                    }
                    count++;
                }
            });

            if (count > 0) {
                renderData();
                saveToStorage();
                showToast(`Updated ${count} packages!`, true);
            }
        }

        function saveToStorage(silent = true) {
            localStorage.setItem('pricebook-admin', JSON.stringify(pricebookData));
            if (!silent) {
                showToast('Progress saved!', true);
            }
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('pricebook-admin');
            if (saved) {
                pricebookData = JSON.parse(saved);
                renderData();
                showToast('Loaded saved progress!', true);
            } else {
                showToast('No saved data found', false);
            }
        }

        function exportJSON() {
            if (!pricebookData) {
                showToast('No data to export', false);
                return;
            }

            pricebookData.lastUpdated = new Date().toISOString();

            // Recalculate starting prices
            pricebookData.categories.forEach(cat => {
                cat.startingAt = Math.min(...cat.packages.map(p => p.price));
            });

            const json = JSON.stringify(pricebookData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'pricebook.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Exported pricebook.json! Copy to data/ folder.', true);
        }

        function showToast(message, success = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (success ? ' success' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Update stats without re-rendering
        function updateStats() {
            if (!pricebookData) return;

            let totalPackages = 0;
            let assignedTiers = 0;
            let upsellsConfigured = 0;
            let imagesSet = 0;

            pricebookData.categories.forEach(cat => {
                if (cat.heroImage) imagesSet++;
                cat.packages.forEach(pkg => {
                    totalPackages++;
                    if (pkg.tier) assignedTiers++;
                    if (pkg.upsellTo && pkg.upsellTo.length > 0) upsellsConfigured++;
                    if (pkg.image) imagesSet++;
                });
            });

            document.getElementById('totalPackages').textContent = totalPackages;
            document.getElementById('totalCategories').textContent = pricebookData.categories.length;
            document.getElementById('assignedTiers').textContent = assignedTiers;
            document.getElementById('upsellsConfigured').textContent = upsellsConfigured;
            document.getElementById('imagesSet').textContent = imagesSet;
        }

        // Starting At Override
        function setStartingAtOverride(categoryName, value) {
            const cat = pricebookData.categories.find(c => c.name === categoryName);
            if (cat) {
                const numValue = parseFloat(value);
                cat.startingAtOverride = numValue > 0 ? numValue : null;
                saveToStorage();
            }
        }

        // Position Adjuster State
        let currentPositionCategory = null;
        let imagePosition = { x: 50, y: 50 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };

        function openPositionAdjuster(categoryName) {
            const cat = pricebookData.categories.find(c => c.name === categoryName);
            if (!cat || !cat.heroImage) return;

            currentPositionCategory = categoryName;
            document.getElementById('positionCategoryName').textContent = categoryName;
            document.getElementById('positionImage').src = cat.heroImage;

            // Load existing position or default to center
            if (cat.heroImagePosition) {
                const [x, y] = cat.heroImagePosition.split(' ').map(v => parseFloat(v));
                imagePosition = { x: x || 50, y: y || 50 };
            } else {
                imagePosition = { x: 50, y: 50 };
            }
            updateImagePosition();

            document.getElementById('positionModal').classList.add('open');
            setupDragListeners();
        }

        function closePositionAdjuster() {
            document.getElementById('positionModal').classList.remove('open');
            currentPositionCategory = null;
            removeDragListeners();
        }

        function resetImagePosition() {
            imagePosition = { x: 50, y: 50 };
            updateImagePosition();
        }

        function saveImagePosition() {
            if (!currentPositionCategory) return;

            const cat = pricebookData.categories.find(c => c.name === currentPositionCategory);
            if (cat) {
                cat.heroImagePosition = `${imagePosition.x}% ${imagePosition.y}%`;
                saveToStorage();
                showToast('Image position saved!', true);
            }
            closePositionAdjuster();
        }

        function updateImagePosition() {
            const img = document.getElementById('positionImage');
            img.style.objectPosition = `${imagePosition.x}% ${imagePosition.y}%`;
            img.style.left = `${50 - imagePosition.x}%`;
            img.style.top = `${50 - imagePosition.y}%`;
        }

        function setupDragListeners() {
            const frame = document.getElementById('positionFrame');
            frame.addEventListener('mousedown', startDrag);
            frame.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function removeDragListeners() {
            const frame = document.getElementById('positionFrame');
            frame.removeEventListener('mousedown', startDrag);
            frame.removeEventListener('touchstart', startDrag);
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            const pos = e.touches ? e.touches[0] : e;
            dragStart = { x: pos.clientX, y: pos.clientY };
        }

        function onDrag(e) {
            if (!isDragging) return;
            e.preventDefault();

            const pos = e.touches ? e.touches[0] : e;
            const deltaX = (pos.clientX - dragStart.x) * 0.3;
            const deltaY = (pos.clientY - dragStart.y) * 0.3;

            imagePosition.x = Math.max(0, Math.min(100, imagePosition.x - deltaX));
            imagePosition.y = Math.max(0, Math.min(100, imagePosition.y - deltaY));

            dragStart = { x: pos.clientX, y: pos.clientY };
            updateImagePosition();
        }

        function endDrag() {
            isDragging = false;
        }
    </script>
</body>
</html>
